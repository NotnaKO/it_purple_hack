<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Analytics and Metrics</title>
    <style>
        body {
            background-color: #fff; /* белый цвет фона */
            color: #000; /* черный цвет текста */
            font-family: Arial, sans-serif; /* шрифт */
        }
        h1 {
            font-size: 2em; /* размер шрифта заголовка */
            /* text-align: center; /* выравнивание по центру */
            text-transform: uppercase; /* преобразование текста в ВЕРХНИЙ РЕГИСТР */
            letter-spacing: 4px; /* межбуквенное расстояние */
        }
        h1 .comandname {
            text-transform: none; /* преобразование текста в ВЕРХНИЙ РЕГИСТР */
        }
        h2 {
            font-size: 1.3em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        h2.bigger {
            font-size: 1.6em;
            letter-spacing: 2px;
        }
        .container {
            display: flex;
        }
        .column {
            flex: 1;
            padding: 10px;
        }
        .json {
            /* white-space: pre-wrap; */
            background-color: #f0f0f0;
            margin-top: 5px;
            padding: 10px;
            border-radius: 5px;
        }
        .grey-background {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
        }
        .input {
            margin-bottom: 10px;
            margin-right: 10px;
            width: calc(100% - 10px);
            padding: 5px;
        }

        .grey {
            background-color: #f0f0f0;
        }

        button {
            margin-bottom: 2px;
        }

        #sendCheckbox {
            padding: 0;
        }
        #sendButton {
            margin: 5px;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: none; /* initially hide button */
        }
        ol {
            list-style-type: none;
            counter-reset: item;
        }
        li {
            margin-bottom: 10px;
            position: relative;
        }
        li::before {
            content: counter(item) ".";
            counter-increment: item;
            color: #000;
            font-weight: bold;
            margin-right: 10px;
        }
        .price {
            color: #000;
            font-weight: bold;
        }
        .download-window {
            margin-top: 20px;
            padding: 10px;
        }
        .download-window a {
            color: black;
            font-weight: bold;
            text-decoration: none;
        }

        .download-window a:hover {
            text-decoration: underline;
        }

        .answer {
            margin: 5px;
            font-family: Arial, sans-serif;
            font-size: 0.8em;
        }


    </style>
</head>
<body>
    <h1>Analytics Support Website by <div type="text" class="comandname">CalculusEnjoyers</div></h1>
    <div class="container">
        <div class="column">
            <h2>Construct storage</h2>
            <input id="baselineInput" class="input" type="text" placeholder="Baseline matrix id">
            <div id="discountInputs">
                <div class="input-row">
                    <input type="text" placeholder="Segment id">
                    <input type="text" placeholder="Discount matrix id">
                    <button class="grey" onclick="removeInput(this)">-</button>
                </div>
            </div>
            <button class="grey" onclick="addInputDiscount()">+</button>
            <button class="grey" onclick="showData()">Show JSON Data</button>
            <div class="json">
            <div id="jsonData"></div>
            <div id="jsonSender"></div>
            </div>

        </div>
        <div class="column">
            <h2>Metrics</h2>
            <div class="grey-background" id="metricsData">
                <ol>
                    <li>Цена товара A: <span class="price">$100</span></li>
                    <li>Цена товара B: <span class="price">$150</span></li>
                    <li>Цена товара C: <span class="price">$80</span></li>
                    <li>Цена товара D: <span class="price">$120</span></li>
                    <li>Скидка на товар E: <span class="price">15%</span></li>
                    <li>Валюта: USD</li>
                    <li>Дата обновления: 01.10.2021</li>
                    <li>Цена доставки: <span class="price">$10</span></li>
                    <li>Общая сумма заказа: <span class="price">$400</span></li>
                </ol>
                <button class="grey">Update metrics</button>
            </div>
        </div>
    </div>

    <h2 class="bigger">Price matrix manipulation</h2>
    <div class="container">
        <div class="column">
            <h2>Update/Insert rows in matrix</h2>
            <div class="grey-background">
            <input id="UpdateIDInput" class="input" type="text" placeholder="Matrix id">
            <div id="updateInputs">
                <div class="input-row">
                    <input type="text" placeholder="Location id">
                    <input type="text" placeholder="Category id">
                    <input type="text" placeholder="Price">
                    <button class="grey" onclick="removeInput(this)">-</button>
                </div>
            </div>
            <button class="grey" onclick="addInputUpdate()">+</button>
            <button class="grey" onclick="sendUpdate()">Update table</button>
        </div>
        </div>
        <div class="column">
            <h2>Add matrix to price manager</h2>
            <input type="text" id="adderInput" class="input" placeholder="Enter matrix name">
            <button class="grey" onclick="addRequest()">Make request</button>
            <label class="answer" id="adderAnswer"></label>
            <h2>Get matrix id from price manager</h2>
            <input id="getterInput" class="input" type="text" placeholder="Enter matrix name">
            <button class="grey" onclick="getRequest()">Make request</button>
            <label class="answer" id="getterAnswer"></label>
        </div>
    </div>

    <h2 class="bigger">Download</h2>
    <div class="download-window">
        <a href="locations.txt" download>Location graph</a> | <a href="categories.txt" download>Microcategory graph</a>
    </div>

    <script>
        function showData() {
            const baselineInput = document.getElementById('baselineInput').value;
            const discountRows = document.querySelectorAll('#discountInputs .input-row');
            const discounts = {};


            discountRows.forEach(row => {
                const discountSegmentIdInput = row.querySelector('input[type="text"]:first-child');
                const valueInput = row.querySelector('input[type="text"]:nth-child(2)');

                let discountSegmentId = parseInt(discountSegmentIdInput.value, 10);
                const value = valueInput.value;

                if (!isNaN(discountSegmentId) && Number.isInteger(discountSegmentId)) {
                    discounts[discountSegmentId] = value;
                } else {
                    alert('Discount Segment ID should be an integer. Please enter a valid integer.');
                    return
                }
            });

            const jsonData = {
                baseline: baselineInput,
                discounts: discounts
            };

            const jsonDataDiv = document.getElementById('jsonData');
            jsonDataDiv.innerHTML = `<pre>${JSON.stringify(jsonData, null, 2)}</pre>`;

            const jsonDataDiv2 = document.getElementById('jsonSender');
            jsonDataDiv2.innerHTML = `<input type="checkbox" id="sendCheckbox" onchange="toggleSendButton()">Check to enable button
            <button id="sendButton" onclick="sendStorage()">Send to server</button>`;
        }

        function addInputUpdate() {
            const discountInputs = document.getElementById('updateInputs');

            const newInputRow = document.createElement('div');
            newInputRow.classList.add('input-row');
            newInputRow.innerHTML = `
                <input type="text" placeholder="Location id">
                <input type="text" placeholder="Category id">
                <input type="text" placeholder="Price">
                <button class="grey" onclick="removeInput(this)">-</button>
            `;

            discountInputs.appendChild(newInputRow);
        }

        function addInputDiscount() {
            const discountInputs = document.getElementById('discountInputs');

            const newInputRow = document.createElement('div');
            newInputRow.classList.add('input-row');
            newInputRow.innerHTML = `
                <input type="text" placeholder="Segment id">
                <input type="text" placeholder="Discount matrix id">
                <button class="grey" onclick="removeInput(this)">-</button>
            `;

            discountInputs.appendChild(newInputRow);
        }

        function removeInput(button) {
            button.parentNode.remove();
        }

        function toggleSendButton() {
            const checkbox = document.getElementById('sendCheckbox');
            const button = document.getElementById('sendButton');

            if (checkbox.checked) {
                button.style.display = 'block'; // Show the button
            } else {
                button.style.display = 'none'; // Hide the button
            }
        }

        function addRequest() {
            // Отправляем GET запрос
            const data = document.getElementById('adderInput').value;
            console.log(`/add_request?data="${data}"`)
            fetch(`/add_request?data=${data}`)
            .then(response => response.json())
            .then(data => {
                console.log('GET запрос выполнен успешно:', data);
                const adderAnswerDiv = document.getElementById('adderAnswer');
                adderAnswerDiv.textContent = " Мatrix got id: " + data["res"];
            })
            .catch(error => {
                console.error('Ошибка при выполнении GET запроса:', error);
            });
        }

        function getRequest() {
            // Отправляем GET запрос
            const data = document.getElementById('getterInput').value;
            console.log(`/add_request?data="${data}"`)
            fetch(`/add_request?data=${data}`)
            .then(response => response.json())
            .then(data => {
                console.log('GET запрос выполнен успешно:', data);
                const getterAnswerDiv = document.getElementById('getterAnswer');
                getterAnswerDiv.textContent = " Matrix has id: " + data["res"];
            })
            .catch(error => {
                console.error('Ошибка при выполнении GET запроса:', error);
            });
        }

        function sendUpdate() {
            const updateIDInput = document.getElementById('UpdateIDInput').value;
            const updateRows = document.querySelectorAll('#updateInputs .input-row');
            const updates = [];

            updateRows.forEach(row => {
                const locationIdInput = row.querySelector('input[type="text"]:first-child');
                const categoryIdInput = row.querySelector('input[type="text"]:nth-child(2)');
                const valueInput = row.querySelector('input[type="text"]:nth-child(3)');

                let locationId = parseInt(locationIdInput.value, 10);
                let categoryId = parseInt(categoryIdInput.value, 10);
                let value = parseInt(valueInput.value, 10);

                if (!isNaN(locationId) && Number.isInteger(locationId)) {
                    if (!isNaN(categoryId) && Number.isInteger(categoryId)) {
                        if (!isNaN(value) && Number.isInteger(value)) {
                            updates.push([locationId, categoryId, value]);
                        } else {
                            alert('Location ID "' + locationIdInput + '" should be an integer. Please enter a valid integer.');
                            return;
                        }
                    } else {
                        alert('Category ID "' + categoryIdInput + '" should be an integer. Please enter a valid integer.');
                        return;
                    }
                } else {
                    alert('Price "' + valueInput + '" should be an integer. Please enter a valid integer.');
                    return;
                }
            });

            const jsonData = {
                update_matrix: updateIDInput,
                updates: updates
            };

            fetch('/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData, null, 2)
            })
            .then(response => {
                if (response.ok) {
                    alert('Data sent successfully via POST request.');
                } else {
                    alert('Error sending data.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function sendStorage() {
            const jsonString = document.getElementById('jsonData').textContent;
            console.log('Строка из элемента "jsonData":', jsonString);

            fetch('/storage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: jsonString
            })
            .then(response => {
                if (response.ok) {
                    alert('Data sent successfully via POST request.');
                } else {
                    alert('Error sending data.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    </script>
</body>
</html>

